---
published: true
layout: post
title: "RE:CYCLE - интересен и малък алгоритъм за покритие"
category: tech
---

За проекта [RE:CYCLE](http://recycle.obshtestvo.bg) ни трябваше да зареждаме точки малко по малко, а не всичко наведнъж. 

И за да не се повтаря зареждането на едни и същи точки, трябваше да знаем какво вече е заредил потребителя. Тази задача на следенето какво е заредил и какво не се оказа не много проста. Един вид трябва да изградим покритие на това което е видял потребителя.

За покритието се помисли относно случаите:

 - потребителят зарежда сайта за първи път - това е ясно
 - потребителят мърда картата малко с мишката - _не искаме всеки път като мръдне с 1см да зареждаме точки._
 - потребителят zoom-ва картата (назад или напред) - _това означава че след zoom, във видимата част от картата все още има точки от предишно зареждане, но все пак е нужно и ново зареждане за областите около тези точки_
 - потребителят рязко сменя локацията на картата чрез полето за смяна на адрес - _това означава че покритието ще е разпокъсано, а не винаги сменящо се от едно място на друго_

За решението:

 1. когато потребителят зареди първи път сайта му се зареждат точки от район 9 пъти по-голям от видимия на екрана му. От всяка страна на екрана му по още един екран. Нещо такова: 
   ![Екрани](/media/recycle-coverage-example.png) 
   
   Това прави покритието в размери на 9 екрана, за да може, ако човек мръдне екрана малко да не трябва веднага да се прави зареждане.
 1. когато потребителят излезе извън началното покритие (_било то с zoom, доста мърдане или въвеждане на нов адрес далеч от текущния_) се проверява дали четирита ъгъла на видимия екран попадат в покритието, ако не попадат, тогава се прави ново зареждане за точки. Зареждането е отново в размер 9x текущия екран. Паралено с това, новозареденият район се слива със стария, за да се опресни покритието.

За изграждането и поддържането на покритието се се сливат райони с различни размери, различни правоъгълници в размери на екрана, с различен zoom. За да стане това сливане се иползва библиотека за манипулация на вектори: [Clipperjs](http://sourceforge.net/p/jsclipper/wiki/Home%206/).

Ето как би изглеждало покритието от 2 сляти района ако потребителят е заредил сайта в центъра на софия и е преместил картата на югоизток:
<iframe width="100%" height="300" src="http://jsfiddle.net/uF6ec/10/embedded/result/" allowfullscreen="allowfullscreen" frameborder="0"></iframe>

А ето и [кода за покритието](https://github.com/obshtestvo/recycle/blob/master/ecomap/static/js/map/locationManager.js#L287): 
<script src="http://gist-it.appspot.com/github/obshtestvo/recycle/blob/9c4ade32f1a215049d62c941b4f64d478045ffa7/ecomap/static/js/map/locationManager.js?slice=286:"></script>
